# Form Storage Observer

The `FormStorageObserver` is an [extension of the `FormObserver`](../form-observer/guides.md#extending-the-formobserver-with-specialized-logic) that stores form data in [`localStorage`](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) as a user interacts with your forms. Additionally, it provides methods to load form data from `localStorage` (for instance, when a user refreshes the page) and clear form data from `localStorage` (when the data is no longer needed). All storage data generated by the `FormStorageObserver` is [scoped](#localstorage-data-scoping); so you can observe multiple forms simultaneously without worrying about data clashing. As a child of the `FormObserver`, the `FormStorageObserver` inherits the same [benefits](../form-observer/README.md#features-and-benefits) as its parent class.

**Example**

```html
<textarea name="external-textbox" form="my-form"></textarea>

<form id="my-form" name="example">
  <input name="textbox" type="text" />

  <select name="combobox">
    <option>1</option>
    <option>2</option>
    <option>3</option>
  </select>
</form>
```

```js
import { FormStorageObserver } from "@form-observer/core";
// or import FormStorageObserver from "@form-observer/core/FormStorageObserver";

// Save a field's value to `localStorage` whenever it changes
const observer = new FormStorageObserver("change");
const form = document.querySelector("form[name='example']");
observer.observe(form);
```

## API

### Constructor: `FormStorageObserver(types, options)`

The `FormStorageObserver()` constructor creates a new observer and configures it with the `options` that you pass in. Because the `FormStorageObserver` only focuses on one task, it has a simple constructor with no overloads.

#### Parameters

<dl>
  <dt><code>types</code></dt>
  <dd>A string <em>or</em> an array of strings representing the type(s) of event(s) that should cause a form's data to be saved to <code>localStorage</code>. As with the <code>FormObserver</code>, the string(s) can be <a href="https://developer.mozilla.org/en-US/docs/Web/Events">commonly recognized</a> event types <em>or</em> your own custom event types.</dd>

  <dt><code>options</code> (Optional)</dt>
  <dd>
    <p>The options used to configure the <code>FormStorageObserver</code>. The following properties can be provided:</p>
    <dl>
      <dt><code>automate</code></dt>
      <dd>
        <p>Indicates whether or not the observer should automate the loading/removal of a form's <code>localStorage</code> data. This option accepts one of four values:</p>
        <ul>
          <li>
            <code>loading</code> (Default): Indicates that when a form is <a href="#method-formstorageobserverobserveform-htmlformelement-boolean"><code>observed</code></a>, its <code>localStorage</code> data should be loaded into its fields.
          </li>
          <li>
            <code>deletion</code>: Indicates that when a form is <a href="#method-formstorageobserverunobserveform-htmlformelement-boolean"><code>unobserved</code></a>, its <code>localStorage</code> data should be deleted entirely.
          </li>
          <li>
            <code>both</code>: Indicates that the observer should automate data loading <em>and</em> data deletion. Behaves as if <code>loading</code> and <code>deletion</code> were specified simultaneously.
          </li>
          <li>
            <code>neither</code>: Indicates that the observer shouldn't automate data loading or data deletion. You are responsible for calling <a href="#static-method-formstorageobserverloadform-htmlformelement-name-string-void"><code>load()</code></a> and <a href="#static-method-formstorageobserverclearform-htmlformelement-name-string-void"><code>clear()</code></a> whenever you want to load or delete data from <code>localStorage</code>.
          </li>
        </ul>
      </dd>
      <dt><code>useEventCapturing</code></dt>
      <dd>Indicates that the observer's event listener should be called during the event capturing phase instead of the event bubbling phase. Defaults to <code>false</code>. See <a href="https://www.w3.org/TR/DOM-Level-3-Events/#event-flow">DOM Event Flow</a> for more details on event phases.</dd>
    </dl>
  </dd>
</dl>

**Example**

```js
const observer = new FormStorageObserver("change", { automate: "both" });
const form = document.querySelector("form[name='example']");

observer.observe(form);
form.elements[0].value = "New Value";
form.elements[0].dispatchEvent(new Event("change")); // Causes the first field's data to be saved to `localStorage`
```

### Static Method: `FormStorageObserver.load(form: HTMLFormElement, name?: string): void`

Loads a form's `localStorage` data into its fields. This method can be called even if no forms are actively being observed.

#### Parameters

<dl>
  <dt><code>form</code></dt>
  <dd>The <code>HTMLFormElement</code> whose <code>localStorage</code> data should be loaded.</dd>

  <dt><code>name</code> (Optional)</dt>
  <dd>The <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#name">name</a> of the form field whose <code>localStorage</code> data should be loaded. If this argument is omitted, then <strong>all</strong> of the form's <code>localStorage</code> data will be loaded into its fields.</dd>
</dl>

**Example**

```js
const form = document.querySelector("form[name='example']");
const input = document.querySelector("input[name='textbox']");

FormStorageObserver.load(form, input.name); // Loads _only_ the `localStorage` data for the `input`
FormStorageObserver.load(form); // Loads the _entire_ form's `localStorage` data
```

### Static Method: `FormStorageObserver.clear(form: HTMLFormElement, name?: string): void`

Clears a form's `localStorage` data. This method can be called even if no forms are actively being observed.

#### Parameters

<dl>
  <dt><code>form</code></dt>
  <dd>The <code>HTMLFormElement</code> whose <code>localStorage</code> data should be deleted.</dd>

  <dt><code>name</code> (Optional)</dt>
  <dd>The <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#name">name</a> of the form field whose <code>localStorage</code> data should be deleted. If this argument is omitted, then <strong>all</strong> of the form's <code>localStorage</code> data will be deleted.</dd>
</dl>

**Example**

```js
const form = document.querySelector("form[name='example']");
const textarea = document.querySelector("textarea[name='external-textbox']");

FormStorageObserver.clear(form, textarea.name); // Clears _only_ the `localStorage` data for the `textarea`
FormStorageObserver.clear(form); // Clears the _entire_ form's `localStorage` data
```

### Method: `FormStorageObserver.observe(form: HTMLFormElement): boolean`

Instructs the observer to save a form's data to `localStorage` whenever a user interacts with its fields. The observer will only save data to `localStorage` when a field belonging to the form emits an event matching one of the `types` that were specified during the observer's construction.

All data saved to `localStorage` is [scoped](#localstorage-data-scoping) by form `name` and field `name` to prevent data clashing. For this reason, you _must_ give a valid `name` to every field that you want to participate in form data storage. **If a field does not have a `name`, then its data _will not_ be saved to `localStorage`.** (It is also recommended to give a `name` to every form element that the `FormStorageObserver` observes, but this is not required.)

> Note: Sensitive fields (i.e., `<input type="password" />`, `<input type="file" />`, and `<input type="hidden" />`) and form controls that lack legitimate form values (i.e., `<fieldset>`, `<output>`, and `<object>`) are **ignored** by the `FormStorageObserver`.

If the provided form element was not being watched before `observe()` was called, the method will run any necessary setup logic and return `true`. (This setup logic includes loading `localStorage` data into all the form's fields if the observer's `automate` option is `loading` or `both`.) Otherwise, the method does nothing and returns `false`.

**Example**

```js
const observer = new FormStorageObserver("change"); // By default, the `automate` option is `loading`
const form = document.querySelector("form[name='example']");

observer.observe(form); // Returns `true`, loads the _entire_ form's `localStorage` data
observer.observe(form); // Returns `false`, does nothing

form.elements[0].value = "Some new value to save";
form.elements[0].dispatchEvent(new Event("change")); // Field's data gets saved to `localStorage`
```

### Method: `FormStorageObserver.unobserve(form: HTMLFormElement): boolean`

Instructs the observer to stop watching a form for user interactions. The form's data will no longer be saved to `localStorage` when a user interacts with the form's fields.

If the provided form element was being watched before `unobserve()` was called, the method will run any necessary teardown logic and return `true`. (This teardown logic includes deleting all of the form's `localStorage` data if the observer's `automate` option is `deletion` or `both`.) Otherwise, the method does nothing and returns `false`.

**Example**

```js
const observer = new FormStorageObserver("change", { automate: "deletion" });
const form = document.querySelector("form[name='example']");
observer.unobserve(form); // Returns `false`, does nothing

observer.observe(form);
form.elements[0].value = "Some new value to save";
form.elements[0].dispatchEvent(new Event("change")); // Field's data gets saved to `localStorage`

observer.unobserve(form); // Returns `true`, clears the _entire_ form's `localStorage` data
form.elements[1].value = "A different value for a different field";
form.elements[1].dispatchEvent(new Event("change")); // Does nothing, the form is no longer being observed
```

### Method: `FormStorageObserver.disconnect(): void`

Instructs the observer to stop watching **all** forms for user interactions. This is effectively the same as calling [`FormStorageObserver.unobserve()`](#method-formstorageobserverunobserveform-htmlformelement-boolean) on all form elements that the observer was previously watching. The benefit of using `disconnect()` is that it provides a quick and easy way to stop watching all forms in your application without requiring you to provide references to those forms.

**Example**

```js
const observer = new FormStorageObserver("change");
const [form1, form2] = Array.from(document.getElementsByTagName("form"));

observer.observe(form1);
observer.observe(form2);
observer.disconnect(); // `unobserve`s ALL forms

// Both calls return `false` because the forms were already `unobserve`d
observer.unobserve(form1);
observer.unobserve(form2);

// Both actions do nothing because the forms were already `unobserve`d
form1.elements[0].value = "Value in 1st Form";
form1.elements[0].dispatchEvent(new Event("change"));

form2.elements[0].value = "Other Value in 2nd Form";
form2.elements[0].dispatchEvent(new Event("change"));
```

## `localStorage` Data Scoping

The `FormStorageObserver` scopes all of the data that it saves to `localStorage` to prevent data clashing. All of the storage keys that it generates have the following format: `form:<FORM_NAME>:<FIELD_NAME>`. (For example, `form:signup:email`.) Although it is not necessary to know what the different parts of the storage key format represent, we've explained them below for those who are interested.

<dl>
  <dt><code>form</code></dt>
  <dd>
    The raw string, <code>form</code>, is prepended to <em>all</em> of the storage keys that the <code>FormStorageObserver</code> generates. This string is intended to prevent the <code>FormStorageObserver</code>&apos;s data from clashing with other storage data that is not related to it.
  </dd>

  <dt><code>FORM_NAME</code></dt>
  <dd>
    The <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/form#name"><code>name</code></a> of the form element that owns the storage data. This string is intended to prevent one form's storage data from clashing with another form's storage data. If a form does not have a <code>name</code>, then the string <code>global-scope</code> will be used during data storage instead. (In general, it is not recommended to store a form's data in the "global scope", though it is permitted.)
  </dd>

  <dt><code>FIELD_NAME</code></dt>
  <dd>
    The <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#name"><code>name</code></a> of the field that owns the storage data. This string is intended to prevent one field's storage data from clashing with the storage data of another field that belongs to the same form.
  </dd>
</dl>

## What's Next?

- Read our [guides](./guides.md) to learn about helpful ways to use the `FormStorageObserver`.
- Check out our built-in solution for [form validation](../form-validity-observer/README.md).
